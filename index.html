<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kleingartenverein Pfuhl Eile - Garten Nr. 40 - </title>
<style>
  :root{
    --glass-bg: rgba(255,255,255,0.34);
    --glass-border: rgba(255,255,255,0.6);
    --muted: #4b5563;
    --accent-green: #16a34a;
    --accent-soft: rgba(34,197,94,0.08);
    --radius: 14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
    color:#0f172a;
    background: linear-gradient(135deg, rgba(212,244,222,0.95), rgba(238,249,240,0.92));
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    backdrop-filter: blur(30px);
  }

  header { padding:14px 16px 6px; text-align:center; }
  header h1 { margin:0; font-size:1.25rem; font-weight:600; color:#052e16; }

  .container{
    max-width:1100px;
    margin: 12px auto;
    padding: 0 12px 12px 12px; /* unten Platz */
    display:grid;
    gap:12px;
  }

  /* Import/Export bar */
  .iebar{
    display:flex;
    gap:8px;
    justify-content:center;
    align-items:center;
    padding:8px;
  }
  .iebar button{
    background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.8));
    border:1px solid rgba(6,95,70,0.06);
    padding:8px 12px;
    border-radius:12px;
    font-size:14px;
    cursor:pointer;
  }

  /* Layout: mobile einspaltig; desktop zweispaltig */
  .mainGrid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
  }
  @media (min-width: 980px) {
    .mainGrid {
      grid-template-columns: 1.1fr 0.9fr;
      grid-auto-rows: auto;
      align-items: start;
    }
    /* Wetter + ToDo über volle Breite */
    .mainGrid > .weather,
    .mainGrid > .todo {
      grid-column: 1 / -1;
    }
  }

  /* glass card */
  .glass{
    background: var(--glass-bg);
    border-radius: var(--radius);
    border: 1px solid rgba(255,255,255,0.6);
    box-shadow: 0 8px 30px rgba(2,6,23,0.06);
    backdrop-filter: blur(12px) saturate(1.1);
    padding:12px;
  }

  /* WEATHER */
  .weather{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
    text-align:center;
  }
  .weather-top{
    display:flex;
    align-items:center;
    gap:10px;
    width:100%;
    justify-content:center;
  }
  .weather-icon{ width:28px; height:28px; display:inline-block; }
  .weather-temp{ font-weight:700; font-size:1.1rem; color:#064e3b; }
  .weather-loc{ font-size:0.9rem; color:var(--muted); }
  .weather-divider{
    width:60%;
    height:1px;
    background: rgba(6,95,70,0.08);
    border-radius:2px;
  }
  .rain-prob{ font-size:0.9rem; color:var(--muted); }

  /* TODO box */
  .todo-list{ display:flex; flex-direction:column; gap:6px; margin-top:6px; }
  .todo-item{
    background: rgba(255,255,255,0.5);
    border-radius:10px;
    padding:8px;
    font-size:0.95rem;
    display:flex; justify-content:space-between; gap:8px; align-items:center;
  }

  /* CALENDAR */
  .calendar-area{ display:block; }
  .cal-controls{ display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px; flex-wrap:wrap; }
  .cal-btn{ background:transparent; border:1px solid rgba(6,95,70,0.06); border-radius:8px; padding:6px 8px; cursor:pointer; font-size:14px; }
  .month-year{ font-weight:600; color:#063; font-size:1rem; padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.6); }

  .dow-row{ display:grid; grid-template-columns: repeat(7,1fr); gap:6px; margin-bottom:6px; font-size:12px; color:var(--muted); text-align:center; }
  .dow{ padding:6px 0; }
  .calendar-grid{
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    gap:6px;
  }
  .day{
    min-height:72px;
    background: rgba(255,255,255,0.7);
    border-radius:10px;
    padding:6px;
    font-size:13px;
    position:relative;
    overflow:hidden;
  }
  .day .num{ font-size:12px; color:var(--muted); margin-bottom:6px; }
  .event-chip{ display:block; padding:6px 8px; border-radius:10px; font-size:12px; margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .chip-harvest{ background: rgba(239,68,68,0.12); border:1px solid rgba(239,68,68,0.18); color:#7f1d1d; }
  .chip-prune{ background: rgba(245,158,11,0.12); border:1px solid rgba(245,158,11,0.18); color:#6b4508; }

  /* RIGHT COLUMN */
  .rightCol{ display:flex; flex-direction:column; gap:12px; }
  .item{ background: rgba(255,255,255,0.6); padding:8px; border-radius:10px; font-size:13px; }

  /* PLANTS */
  #plantsSection { margin-top:12px; }
  .plants-header{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .toggle-btn{ background:transparent; border:none; color:var(--accent-green); font-weight:600; cursor:pointer; margin-top:8px; }
  .plants-grid{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); margin-top:8px; }
 .plant-box {
  background: var(--glass-bg);
  backdrop-filter: blur(12px) saturate(1.1);
  border-radius: 12px;
  padding: 10px;
  font-size: 13px;
}

.plant-section {
  margin-top: 8px;
  background: var(--glass-bg);
  backdrop-filter: blur(12px) saturate(1.1);
  padding: 8px;
  border-radius: 10px;
  font-size: 13px;
}


  input[type="text"], input[type="number"], select{
    padding:8px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); font-size:14px; width:100%;
    background: rgba(255,255,255,0.9);
  }
  .small{ font-size:13px; color:var(--muted); }
  .hidden{ display:none!important; }
</style>
</head>
<body>
<header><h1>Garten Nr. 40 - Kleingartenverein Pfuhl Eile</h1></header>

<div class="container">

  <!-- Import/Export bar -->
  <div class="glass iebar">
    <button id="exportBtn">Exportieren</button>
    <input id="importFile" type="file" accept=".json,application/json" style="display:none" />
    <button id="importBtn">Importieren</button>
  </div>

  <div class="mainGrid">

    <!-- Wetter -->
    <div class="glass weather" id="weatherBox" title="Wetter: Klick öffnet wetter.com">
      <div class="weather-top">
        <img id="weatherIcon" class="weather-icon" alt="Wetter" src="">
        <div>
          <div class="weather-temp" id="weatherTemp">—°C</div>
          <div class="weather-loc">Pfuhl</div>
        </div>
      </div>
      <div class="weather-divider"></div>
      <div id="rainProb" class="rain-prob">Regenwahrscheinlichkeit: —%</div>
      <div class="weather-divider"></div>
      <div id="waterHint" class="rain-prob">Gießhinweis: —</div>
      <div class="weather-divider"></div>
      <div id="frostWarn" class="rain-prob">Frostwarnung: —</div>
      <div class="weather-divider"></div>
      <div id="sunHours" class="rain-prob">Sonnenstunden: —</div>
      <div class="weather-divider"></div>
      <div id="windWarn" class="rain-prob">Wind/Sturmwarnung: —</div>
      <div class="weather-divider"></div>
      <div id="pollenInfo" class="rain-prob">Pollenflug: —</div>
    </div>

    <!-- ToDo -->
    <div class="glass todo">
      <h3 style="margin:0 0 8px 0;">ToDo-Monatsübersicht</h3>
      <div id="todoList" class="todo-list"></div>
    </div>

    <!-- Kalender -->
    <div class="glass calendar-area">
      <div class="cal-controls">
        <div class="left"><button class="cal-btn" id="prevMonth">‹</button></div>
        <div class="center">
          <div class="month-year" id="monthLabel">Monat</div>
          <select id="yearSelect" class="small"></select>
        </div>
        <div class="right"><button class="cal-btn" id="nextMonth">›</button></div>
      </div>
      <div class="dow-row">
        <div class="dow">Mo</div><div class="dow">Di</div><div class="dow">Mi</div><div class="dow">Do</div>
        <div class="dow">Fr</div><div class="dow">Sa</div><div class="dow">So</div>
      </div>
      <div class="calendar-grid" id="calendarGrid" aria-live="polite"></div>
    </div>

    <!-- Ereignisse + Notizen -->
    <aside class="rightCol">
      <div class="glass events">
        <h3 style="margin:0 0 8px 0;">Ereignis-Liste</h3>
        <div id="eventList" class="small"></div>
      </div>
      <div class="glass notes">
        <h3 style="margin:0 0 8px 0;">Notizen</h3>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <input id="noteInput" type="text" placeholder="Notiz eingeben…" />
          <button id="addNoteBtn">Hinzufügen</button>
        </div>
        <div id="notesList" class="small"></div>
      </div>
    </aside>
  </div>

  <!-- Pflanzen -->
  <div class="glass" id="plantsSection">
    <div class="plants-header">
      <h3 style="margin:0">Pflanzen</h3>
      <button class="toggle-btn" id="plantsToggle">▼ Pflanzen anzeigen</button>
    </div>
    <div id="plantArea" class="plants-grid hidden"></div>
    <div id="plantAdd" class="hidden" style="margin-top:8px;">
      <input id="newPlantName" type="text" placeholder="Neue Pflanze Name" />
      <div style="margin-top:8px;"><button id="addPlantBtn">Hinzufügen</button></div>
    </div>
  </div>

</div>
<script>
/* ===== state & initial data ===== */
const plants = [
  {name:"Hibiskus / Roseneibisch", harvest:false, cut:[6,7]},
  {name:"Zuckerrohr-Palmen", harvest:false, cut:[5,6]},
  {name:"Apfelbaum", harvest:true, harvestRange:[8,9], cut:[2,3]},
  {name:"Kirschbaum", harvest:true, harvestRange:[6,7], cut:[2,3]},
  {name:"Pflaumenbaum", harvest:true, harvestRange:[8,9], cut:[2,3]},
  {name:"Johannisbeere", harvest:true, harvestRange:[7,7], cut:[2,3]},
  {name:"Himbeere", harvest:true, harvestRange:[7,8], cut:[3,4]},
  {name:"Amerikanische Heidelbeere", harvest:true, harvestRange:[7,8], cut:[2,3]},
  {name:"Erdbeeren", harvest:true, harvestRange:[6,7], cut:[2,3]},
  {name:"Fetthenne", harvest:false, cut:[9,10]},
  {name:"Kürbis", harvest:true, unit:"Stück", harvestRange:[9,10]},
  {name:"Zucchini", harvest:true, unit:"Stück", harvestRange:[7,8]},
];

let events = []; // array of textual event entries: "YYYY-MM-DD | label"
let notes = [];  // array of {id,text,iso}

/* ===== DOM references ===== */
const monthLabel = document.getElementById('monthLabel');
const yearSelect = document.getElementById('yearSelect');
const calendarGrid = document.getElementById('calendarGrid');
const eventList = document.getElementById('eventList');
const notesList = document.getElementById('notesList');
const noteInput = document.getElementById('noteInput');
const addNoteBtn = document.getElementById('addNoteBtn');
const todoList = document.getElementById('todoList');
const weatherIcon = document.getElementById('weatherIcon');
const weatherTemp = document.getElementById('weatherTemp');
const rainProbEl = document.getElementById('rainProb');

let current = new Date(); // view month/year

/* ===== helper functions ===== */
function uid(){ return Math.random().toString(36).slice(2,9); }
function pad(n){ return String(n).padStart(2,'0'); }
function isoFor(y,m,d){ return `${y}-${pad(m)}-${pad(d)}`; }

/* ===== year select population ===== */
function populateYears(){
  const y = new Date().getFullYear();
  yearSelect.innerHTML = '';
  for(let i=y-5;i<=y+5;i++){
    const opt = document.createElement('option');
    opt.value = i; opt.textContent = i;
    if(i===current.getFullYear()) opt.selected = true;
    yearSelect.appendChild(opt);
  }
}
populateYears();

/* ===== render calendar ===== */
function renderCalendar(){
  calendarGrid.innerHTML = '';
  const y = current.getFullYear();
  const m = current.getMonth(); // 0..11
  monthLabel.textContent = current.toLocaleString('de-DE',{month:'long', year:'numeric'});

  // Determine Monday-first offset
  const firstDate = new Date(y,m,1);
  const offset = (firstDate.getDay() + 6) % 7; // 0..6, Monday=0
  for(let i=0;i<offset;i++){
    const blank = document.createElement('div');
    blank.className = 'day';
    blank.style.background='transparent';
    calendarGrid.appendChild(blank);
  }

  const daysInMonth = new Date(y,m+1,0).getDate();
  for(let d=1; d<=daysInMonth; d++){
    const cell = document.createElement('div');
    cell.className = 'day';
    const num = document.createElement('div'); num.className='num'; num.textContent = d+'.';
    cell.appendChild(num);

    // Place events that match ISO date prefix
    const isoDate = isoFor(y,m+1,d); // YYYY-MM-DD
    // show events that start with isoDate (we store events as "YYYY-MM-DD | text")
    events.forEach(ev=>{
      if(typeof ev === 'string' && ev.startsWith(isoDate + ' | ')){
        const txt = ev.split(' | ')[1] || ev;
        const chip = document.createElement('div');
        chip.className = 'event-chip ' + (txt.toLowerCase().includes('ernte') ? 'chip-harvest' : 'chip-prune');
        chip.textContent = txt;
        cell.appendChild(chip);
      }
    });

    calendarGrid.appendChild(cell);
  }

  // update ToDo whenever calendar renders
  renderTodo();
}

/* ===== events & activity list rendering ===== */
function addEventForToday(label){
  const now = new Date();
  const iso = isoFor(now.getFullYear(), now.getMonth()+1, now.getDate());
  const entry = `${iso} | ${label}`;
  events.unshift(entry);
  renderEvents();
  renderCalendar();
}
function renderEvents(){
  eventList.innerHTML = '';
  events.forEach(e=>{
    const div = document.createElement('div'); div.className='item';
    const [date,txt] = e.split(' | ');
    div.innerHTML = `<div style="font-weight:600">${txt}</div><div class="small" style="color:var(--muted)">${date}</div>`;
    eventList.appendChild(div);
  });
}

/* ===== notes handling ===== */
function renderNotes(){
  notesList.innerHTML = '';
  notes.slice().reverse().forEach(n=>{
    const div = document.createElement('div'); div.className='item';
    const txt = document.createElement('div'); txt.textContent = n.text;
    const meta = document.createElement('div'); meta.className='small'; meta.style.color='var(--muted)';
    meta.textContent = new Date(n.iso).toLocaleString('de-DE');
    const del = document.createElement('button'); del.textContent='×'; del.style.marginLeft='8px';
    del.onclick = ()=>{ notes = notes.filter(x=>x.id!==n.id); renderNotes(); renderCalendar(); };
    div.appendChild(txt); div.appendChild(meta); div.appendChild(del);
    notesList.appendChild(div);
  });
}
addNoteBtn.addEventListener('click', ()=>{
  const v = noteInput.value.trim(); if(!v) return;
  notes.push({ id: uid(), text: v, iso: new Date().toISOString() });
  noteInput.value = '';
  renderNotes();
  renderCalendar();
});

/* ===== ToDo generation (month-relative) ===== */
function renderTodo(){
  todoList.innerHTML = '';
  const month = current.getMonth() + 1;
  plants.forEach(p=>{
    // Ernte fällig?
    if(Array.isArray(p.harvestRange) && p.harvestRange.length>=2){
      const [from,to] = p.harvestRange;
      // handle wrap-around
      const inRange = from <= to ? (month>=from && month<=to) : (month>=from || month<=to);
      if(inRange){
        const el = document.createElement('div'); el.className='todo-item';
        el.textContent = p.name + ' - Ernte fällig';
        todoList.appendChild(el);
      }
    }
    // Zuschnitt fällig?
    if(Array.isArray(p.cut) && p.cut.length>=2){
      const [from,to] = p.cut;
      const inRange = from <= to ? (month>=from && month<=to) : (month>=from || month<=to);
      if(inRange){
        const el = document.createElement('div'); el.className='todo-item';
        el.textContent = p.name + ' - Zuschnitt fällig';
        todoList.appendChild(el);
      }
    }
  });
}

/* ===== plants rendering (collapsible) ===== */
const plantArea = document.getElementById('plantArea');
const plantAdd = document.getElementById('plantAdd');
const plantsToggle = document.getElementById('plantsToggle');

function renderPlants(){
  plantArea.innerHTML = '';
  plants.forEach((p, idx)=>{
    const box = document.createElement('div');
    box.className='plant-box';

    // Pflanzen-Name
    const title = document.createElement('div');
    title.style.fontWeight='700';
    title.style.marginBottom = '6px';
    title.textContent = p.name;
    box.appendChild(title);

    // --- Zuschnitt ---
    const cutSec = document.createElement('div');
    cutSec.className='plant-section';

    const cutHeader = document.createElement('div');
    cutHeader.style.fontWeight = '600';
    cutHeader.style.marginBottom = '4px';
    cutHeader.textContent = 'Zuschnitt';
    cutSec.appendChild(cutHeader);

    const cutLabel = document.createElement('label');
    const cutCb = document.createElement('input');
    cutCb.type='checkbox';
    let cutState = 0;
    cutCb.addEventListener('click', ()=>{
      cutState++;
      if(cutState===1){ addEventForToday(`${p.name}: Zuschnitt in Arbeit`); }
      else if(cutState===2){ addEventForToday(`${p.name}: Zuschnitt erledigt`); cutCb.disabled=true; }
    });
    cutLabel.appendChild(cutCb);
    cutLabel.append(' erledigt');
    cutSec.appendChild(cutLabel);

    // Zuschnitt Zeitraum
    const fromSel = document.createElement('select');
    const toSel = document.createElement('select');
    fromSel.className='small';
    toSel.className='small';
    const emptyOpt = document.createElement('option');
    emptyOpt.value=''; emptyOpt.text='-';
    fromSel.appendChild(emptyOpt.cloneNode(true));
    toSel.appendChild(emptyOpt.cloneNode(true));
    for(let i=1;i<=12;i++){
      const o=document.createElement('option');
      o.value=i;
      o.textContent = ['Jan','Feb','Mär','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'][i-1];
      if(p.cut && p.cut[0]===i) o.selected=true; fromSel.appendChild(o);
      const o2=o.cloneNode(true); if(p.cut && p.cut[1]===i) o2.selected=true; toSel.appendChild(o2);
    }
    const periodWrap = document.createElement('div');
    periodWrap.style.marginTop='6px';
    periodWrap.append('Zeitraum: ');
    periodWrap.appendChild(fromSel);
    periodWrap.append(' bis ');
    periodWrap.appendChild(toSel);
    fromSel.addEventListener('change', ()=>{ p.cut = [ Number(fromSel.value)||null, Number(toSel.value)||null ]; renderCalendar(); renderTodo(); });
    toSel.addEventListener('change', ()=>{ p.cut = [ Number(fromSel.value)||null, Number(toSel.value)||null ]; renderCalendar(); renderTodo(); });

    cutSec.appendChild(periodWrap);
    box.appendChild(cutSec);

    // --- Ernte ---
    const harvSec = document.createElement('div');
    harvSec.className='plant-section';
    harvSec.style.marginTop = '8px';

    const harvHeader = document.createElement('div');
    harvHeader.style.fontWeight = '600';
    harvHeader.style.marginBottom = '4px';
    harvHeader.textContent = 'Ernte';
    harvSec.appendChild(harvHeader);

    const harvEnableLbl = document.createElement('label');
    const harvEnable = document.createElement('input');
    harvEnable.type='checkbox';
    harvEnable.checked = !!p.harvest;
    harvEnable.addEventListener('change', ()=>{ p.harvest = harvEnable.checked; renderPlants(); renderTodo(); });
    harvEnableLbl.appendChild(harvEnable);
    harvEnableLbl.append(' Ernte aktivieren');
    harvSec.appendChild(harvEnableLbl);

    if(p.harvest){
      // erledigt Checkbox
      const harvDoneLabel = document.createElement('label');
      harvDoneLabel.style.display = 'block';
      harvDoneLabel.style.marginTop = '6px';
      const harvCb = document.createElement('input');
      harvCb.type='checkbox';
      let harvState = 0;
      const amount = document.createElement('input');
      amount.type='number';
      amount.placeholder = p.unit || 'kg';
      amount.style.marginTop = '6px';
      harvCb.addEventListener('click', ()=>{
        harvState++;
        if(harvState===1){ addEventForToday(`${p.name}: Ernte in Arbeit`); }
        else if(harvState===2){ addEventForToday(`${p.name}: Ernte erledigt ${amount.value||''} ${p.unit||'kg'}`); harvCb.disabled=true; }
      });
      harvDoneLabel.appendChild(harvCb);
      harvDoneLabel.append(' erledigt');
      harvSec.appendChild(harvDoneLabel);

      // Erntezeitraum
      const hf = document.createElement('select');
      const ht = document.createElement('select');
      hf.className='small';
      ht.className='small';
      hf.appendChild(emptyOpt.cloneNode(true));
      ht.appendChild(emptyOpt.cloneNode(true));
      for(let i=1;i<=12;i++){
        const o=document.createElement('option');
        o.value=i;
        o.textContent=['Jan','Feb','Mär','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'][i-1];
        if(p.harvestRange && p.harvestRange[0]===i) o.selected=true; hf.appendChild(o);
        const o2=o.cloneNode(true); if(p.harvestRange && p.harvestRange[1]===i) o2.selected=true; ht.appendChild(o2);
      }
      hf.addEventListener('change', ()=>{ p.harvestRange = [ Number(hf.value)||null, Number(ht.value)||null ]; renderTodo(); });
      ht.addEventListener('change', ()=>{ p.harvestRange = [ Number(hf.value)||null, Number(ht.value)||null ]; renderTodo(); });

      const harvRangeWrap = document.createElement('div');
      harvRangeWrap.style.marginTop='6px';
      harvRangeWrap.append('Zeitraum: ');
      harvRangeWrap.appendChild(hf);
      harvRangeWrap.append(' bis ');
      harvRangeWrap.appendChild(ht);
      harvSec.appendChild(harvRangeWrap);
      harvSec.appendChild(amount);
    }

    box.appendChild(harvSec);

    // Delete button
    const del = document.createElement('button');
    del.textContent = 'Pflanze löschen';
    del.style.marginTop = '8px';
    del.addEventListener('click', ()=>{ plants.splice(idx,1); renderPlants(); renderCalendar(); renderTodo(); });

    box.appendChild(del);
    plantArea.appendChild(box);
  });
}


/* ===== toggle plants UI ===== */
const toggleBtn = document.getElementById('plantsToggle');
toggleBtn.addEventListener('click', ()=>{
  const visible = !plantArea.classList.contains('hidden');
  if(visible){
    plantArea.classList.add('hidden'); plantAdd.classList.add('hidden'); toggleBtn.textContent = '▼ Pflanzen anzeigen';
  } else {
    plantArea.classList.remove('hidden'); plantAdd.classList.remove('hidden'); toggleBtn.textContent = '▲ Pflanzen verbergen';
    renderPlants();
  }
});

/* ===== add plant button ===== */
document.getElementById('addPlantBtn').addEventListener('click', ()=>{
  const name = document.getElementById('newPlantName').value.trim();
  if(!name) return;
  plants.push({ name, harvest:true, harvestRange:null, cut:null });
  document.getElementById('newPlantName').value = '';
  renderPlants();
  renderTodo();
});

/* ===== export / import ===== */
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const payload = { plants, events, notes };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `garten-dashboard-${new Date().toISOString().slice(0,10)}.json`; a.click();
  URL.revokeObjectURL(a.href);
});
document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
document.getElementById('importFile').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=> {
    try{
      const data = JSON.parse(r.result);
      if(Array.isArray(data.plants)) { // replace only if valid
        plants.length = 0;
        data.plants.forEach(p => plants.push(p));
      }
      events = Array.isArray(data.events) ? data.events.slice() : [];
      notes = Array.isArray(data.notes) ? data.notes.slice() : [];
      renderPlants(); renderCalendar(); renderEvents(); renderNotes(); renderTodo();
      alert('Import erfolgreich.');
    }catch(err){ alert('Import fehlgeschlagen: ' + err.message); }
  };
  r.readAsText(f);
});

/* ===== weather (open-meteo) with rain probability for current day ===== */
async function loadWeather(){
  try {
    const url = 'https://api.open-meteo.com/v1/forecast?latitude=48.408&longitude=10.0375&daily=precipitation_probability_mean,precipitation_sum,temperature_2m_min,sunshine_duration,windspeed_10m_max&current_weather=true&timezone=Europe%2FBerlin';
    const res = await fetch(url);
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();

    const cw = data.current_weather || {};

    // Temperatur + Icon (sicher setzen)
    if (cw.temperature !== undefined) {
      weatherTemp.textContent = Math.round(cw.temperature) + '°C';
    } else {
      weatherTemp.textContent = '—°C';
    }
    const code = Number(cw.weathercode ?? -1);
    if(code >= 0){
      if(code < 3) weatherIcon.src = 'https://img.icons8.com/ios-filled/50/000000/sun.png';
      else if(code < 61) weatherIcon.src = 'https://img.icons8.com/ios-filled/50/000000/partly-cloudy-day.png';
      else weatherIcon.src = 'https://img.icons8.com/ios-filled/50/000000/rain.png';
    } else {
      weatherIcon.src = '';
    }

    // Regenwahrscheinlichkeit (sicher lesen)
    const probArr = data.daily?.precipitation_probability_mean;
    const prob = Array.isArray(probArr) && probArr.length > 0 ? Math.round(probArr[0]) : null;
    rainProbEl.textContent = prob !== null ? 'Regenwahrscheinlichkeit: ' + prob + '%' : 'Regenwahrscheinlichkeit: —%';

    // Gießhinweis (Niederschlagssumme heute + morgen)
    const precArr = data.daily?.precipitation_sum || [];
    const rainToday = Number(precArr[0] ?? 0);
    const rainTomorrow = Number(precArr[1] ?? 0);
    document.getElementById('waterHint').textContent = 'Gießhinweis: ' + ((rainToday + rainTomorrow) < 1 ? 'Gießen empfohlen' : 'Kein Gießen nötig');

    // Frostwarnung (min-Temperatur)
    const tminArr = data.daily?.temperature_2m_min;
    const tmin = Array.isArray(tminArr) && tminArr.length>0 ? Number(tminArr[0]) : null;
    document.getElementById('frostWarn').textContent = 'Frostwarnung: ' + ((tmin !== null && tmin < 2) ? 'Achtung: Bodenfrost möglich!' : 'Kein Frost erwartet');

    // Sonnenstunden (robuste Umrechnung: falls API Sekunden liefert, in Stunden umrechnen)
    const sunArr = data.daily?.sunshine_duration;
    let sunHours = '—';
    if(Array.isArray(sunArr) && sunArr.length > 0){
      let v = Number(sunArr[0]);
      if(isFinite(v)){
        if(v > 24) v = v / 3600; // Sekunden -> Stunden
        sunHours = (Math.round(v*10)/10) + 'h';
      }
    }
    document.getElementById('sunHours').textContent = 'Sonnenstunden: ' + sunHours;

    // Wind / Sturmwarnung (Fallback auf current_weather.windspeed)
    const windArr = data.daily?.windspeed_10m_max;
    const windVal = (Array.isArray(windArr) && windArr.length>0) ? Number(windArr[0]) : (cw.windspeed ?? null);
    const windText = (windVal === null) ? '—' : (windVal > 50 ? 'Sturmwarnung! (' + windVal + ' km/h)' : windVal + ' km/h');
    document.getElementById('windWarn').textContent = 'Wind: ' + windText;

    // Pollen (separater, sicherer Call; Fehler nicht fatal)
    try{
      const pollenUrl = 'https://api.open-meteo.com/v1/forecast?latitude=48.408&longitude=10.0375&daily=alder_pollen,birch_pollen,grass_pollen,ragweed_pollen&timezone=Europe%2FBerlin';
      const pRes = await fetch(pollenUrl);
      if(pRes.ok){
        const pData = await pRes.json();
        const grass = pData.daily?.grass_pollen;
        let pollenText = '—';
        if(Array.isArray(grass) && grass.length>0){
          const val = Number(grass[0]);
          const labels = ['keine Belastung','gering','mittel','hoch'];
          pollenText = labels[val] ?? String(val);
        }
        document.getElementById('pollenInfo').textContent = 'Pollenflug (Gräser): ' + pollenText;
      } else {
        document.getElementById('pollenInfo').textContent = 'Pollenflug: —';
      }
    } catch(pErr){
      document.getElementById('pollenInfo').textContent = 'Pollenflug: —';
      console.warn('Pollen-API Fehler', pErr);
    }

    // Klick-Verhalten für Wetter-Box
    const wb = document.getElementById('weatherBox');
    if(wb) wb.onclick = () => window.open('https://www.wetter.com/wetter_aktuell/wettervorhersage/7_tagesvorhersage/deutschland/neu-ulm/burlafingen/DE0012164001.html','_blank');

  } catch(err){
    console.warn('Fehler beim Laden der Wetterdaten:', err);
    weatherTemp.textContent = '—°C';
    rainProbEl.textContent = 'Regenwahrscheinlichkeit: —%';
    document.getElementById('waterHint').textContent = 'Gießhinweis: —';
    document.getElementById('frostWarn').textContent = 'Frostwarnung: —';
    document.getElementById('sunHours').textContent = 'Sonnenstunden: —';
    document.getElementById('windWarn').textContent = 'Wind: —';
    document.getElementById('pollenInfo').textContent = 'Pollenflug: —';
  }
}

// einmalig aufrufen + alle 20 Minuten aktualisieren
loadWeather();
setInterval(loadWeather, 20 * 60 * 1000);

/* ===== initial render calls & controls ===== */
document.getElementById('prevMonth').addEventListener('click', ()=>{ current.setMonth(current.getMonth()-1); renderCalendar(); });
document.getElementById('nextMonth').addEventListener('click', ()=>{ current.setMonth(current.getMonth()+1); renderCalendar(); });
yearSelect.addEventListener('change', ()=>{ current.setFullYear(Number(yearSelect.value)); renderCalendar(); });

/* render helpers for events/notes at start */
function renderAll(){
  renderCalendar();
  renderEvents();
  renderNotes();
  renderPlants(); // plants initially hidden; renders but area stays hidden
}
renderAll();

/* ensure ToDo updates when month changes */
(function observeMonthChanges(){
  // already integrated: renderTodo called inside renderCalendar
})();
</script>
</body>
</html>



