<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Garten Nr. 40 - Kleingartenverein Pfuhl Eile</title>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
  :root{
    --glass-bg: rgba(255,255,255,0.34);
    --muted: #4b5563;
    --accent-green: #16a34a;
    --radius: 14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
    color:#0f172a;
    background: linear-gradient(135deg, rgba(212,244,222,0.95), rgba(238,249,240,0.92));
    -webkit-font-smoothing:antialiased;
    padding-bottom:24px;
  }
  header { padding:14px 16px 6px; text-align:center; }
  header h1 { margin:0; font-size:1.25rem; font-weight:600; color:#052e16; }

  .container{ max-width:1100px; margin:12px auto; padding:0 12px; display:grid; gap:12px; }

  .iebar{ display:flex; gap:8px; justify-content:center; align-items:center; padding:8px; }
  .iebar button{ background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.8)); border:1px solid rgba(6,95,70,0.06); padding:8px 12px; border-radius:12px; font-size:14px; cursor:pointer; }

  .glass{ background: var(--glass-bg); border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.6); box-shadow: 0 8px 30px rgba(2,6,23,0.06); backdrop-filter: blur(12px) saturate(1.1); padding:12px; }

  .weather{ display:flex; flex-direction:column; align-items:center; gap:6px; text-align:center; }
  .weather-top{ display:flex; align-items:center; gap:10px; width:100%; justify-content:center; }
  .weather-icon{ width:28px; height:28px; display:inline-block; }
  .weather-temp{ font-weight:700; font-size:1.1rem; color:#064e3b; }
  .weather-loc{ font-size:0.9rem; color:var(--muted); }
  .weather-divider{ width:60%; height:1px; background: rgba(6,95,70,0.08); border-radius:2px; }
  .rain-prob{ font-size:0.9rem; color:var(--muted); }

  /* topBoxes: each half width */
  .topBoxes{ display:flex; gap:10px; }
  .topBoxes > .miniBox{ flex:1; display:flex; flex-direction:column; align-items:center; gap:8px; padding:12px; border-radius:12px; }
  .btn { padding:8px 10px; border-radius:10px; border:none; cursor:pointer; background: linear-gradient(180deg,#ffffff,#f1f8f1); }
  .small{ font-size:13px; color:var(--muted); }

  .todo-list{ display:flex; flex-direction:column; gap:6px; margin-top:6px; }
  .todo-item{ background: rgba(255,255,255,0.5); border-radius:10px; padding:8px; font-size:0.95rem; display:flex; justify-content:space-between; align-items:center; }

  .mainGrid{ display:grid; gap:12px; grid-template-columns:1fr; }
  @media(min-width:980px){ .mainGrid{ grid-template-columns: 1.1fr 0.9fr; } }

  .cal-controls{ display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px; flex-wrap:wrap; }
  .cal-btn{ background:transparent; border:1px solid rgba(6,95,70,0.06); border-radius:8px; padding:6px 8px; cursor:pointer; font-size:14px; }
  .month-year{ font-weight:600; color:#063; font-size:1rem; padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.6); }

  .dow-row{ display:grid; grid-template-columns: repeat(7,1fr); gap:6px; margin-bottom:6px; font-size:12px; color:var(--muted); text-align:center; }
  .calendar-grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; }
  .day{ min-height:72px; background: rgba(255,255,255,0.7); border-radius:10px; padding:6px; font-size:13px; position:relative; overflow:hidden; cursor:pointer; }
  .day.selected{ outline:2px solid var(--accent-green); }
  .num{ font-size:12px; color:var(--muted); margin-bottom:6px; }
  .event-chip{ display:block; padding:6px 8px; border-radius:10px; font-size:12px; margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .chip-harvest{ background: rgba(239,68,68,0.12); border:1px solid rgba(239,68,68,0.18); color:#7f1d1d; }
  .chip-prune{ background: rgba(245,158,11,0.12); border:1px solid rgba(245,158,11,0.18); color:#6b4508; }

  .watering-icon{ position:absolute; right:6px; bottom:6px; font-size:16px; color:var(--accent-green); }

  .rightCol{ display:flex; flex-direction:column; gap:12px; }
  .item{ background: rgba(255,255,255,0.6); padding:8px; border-radius:10px; font-size:13px; }

  .plants-header{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .toggle-btn{ background:transparent; border:none; color:var(--accent-green); font-weight:600; cursor:pointer; margin-top:8px; }
  .plants-grid{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); margin-top:8px; }
  .plant-box{ background: rgba(255,255,255,0.7); border-radius:12px; padding:10px; font-size:13px; }
  .plant-section{ margin-top:8px; background: rgba(255,255,255,0.45); padding:8px; border-radius:10px; font-size:13px; }

  input[type="text"], input[type="number"], select{ padding:8px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); font-size:14px; width:100%; background: rgba(255,255,255,0.9); }

  /* winter checklist inline box styles */
  #winterChecklistInline{ width:100%; margin-top:10px; padding:10px; border-radius:10px; background: rgba(255,255,255,0.9); }
  #checklistItems .row{ display:flex; flex-direction:column; gap:6px; padding:8px; border-radius:8px; background:rgba(245,250,245,1); margin-bottom:6px; }
  #checklistItems .row-top{ display:flex; gap:8px; align-items:center; }
  #checklistItems .row-top input[type="text"]{ flex:1; padding:6px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); }
  #checklistItems .meta { color:var(--muted); font-size:12px; }
  .small-timestamp{ color:var(--muted); font-size:12px; margin-top:4px; }
  .icon-btn { background:transparent; border:none; cursor:pointer; font-size:16px; padding:4px; }
  .hidden { display:none !important; }
</style>
</head>
<body>
<header><h1>Garten Nr. 40 - Kleingartenverein Pfuhl Eile</h1></header>

<div class="container">
  <!-- Import/Export bar -->
  <div class="iebar">
    <button id="exportBtn">Exportieren</button>
    <input id="importFile" type="file" accept=".json,application/json" style="display:none" />
    <button id="importBtn">Importieren</button>
    <div id="syncStatus" style="margin-left:12px;font-size:13px;color:var(--muted)"></div>
  </div>

  <!-- Weather -->
  <div class="glass weather" id="weatherBox" title="Wetter: Klick √∂ffnet wetter.com">
    <div class="weather-top">
      <img id="weatherIcon" class="weather-icon" alt="Wetter" src="">
      <div>
        <div class="weather-temp" id="weatherTemp">‚Äî¬∞C</div>
        <div class="weather-loc">Pfuhl</div>
      </div>
    </div>

    <div class="weather-divider" aria-hidden="true"></div>
    <div id="rainProb" class="rain-prob">Regenwahrscheinlichkeit: ‚Äî%</div>

    <div class="weather-divider" aria-hidden="true"></div>
    <div id="waterHint" class="rain-prob">Gie√ühinweis: ‚Äî</div>

    <div class="weather-divider" aria-hidden="true"></div>
    <div id="frostWarn" class="rain-prob">Frostwarnung: ‚Äî</div>

    <div class="weather-divider" aria-hidden="true"></div>
    <div id="sunHours" class="rain-prob">Sonnenstunden: ‚Äî</div>

    <div class="weather-divider" aria-hidden="true"></div>
    <div id="windWarn" class="rain-prob">Wind: ‚Äî</div>

    <div class="weather-divider" aria-hidden="true"></div>
    <div id="pollenInfo" class="rain-prob">Pollenflug: ‚Äî</div>
  </div>

  <!-- ToDo -->
  <div class="glass">
    <h3 style="margin:0 0 8px 0;">ToDo</h3>
    <div id="todoList" class="todo-list"></div>
  </div>

  <!-- TOP BOXES (Gie√üen + Winter) -->
  <div class="topBoxes">
    <div class="glass miniBox" id="waterBox">
      <button id="waterBtn" class="btn" title="Gie√üen f√ºr ausgew√§hlten Tag (klicken um umzuschalten)">üíß</button>
      <div class="small">vorab Tag in Kalender ausw√§hlen</div>
    </div>

    <div class="glass miniBox" id="winterBox">
      <button id="winterBtn" class="btn" title="Winter-Checkliste √∂ffnen">üóíÔ∏è Winter-Checkliste</button>
      <!-- inline checklist area that expands below when opened -->
      <div id="winterChecklistInline" class="hidden" aria-hidden="true">
        <div style="display:flex;align-items:center;justify-content:center;gap:8px;">
          <input id="newChecklistItem" type="text" placeholder="Neues Element hinzuf√ºgen" />
          <button id="addChecklistBtn" class="btn">+</button>
        </div>
        <div id="checklistItems"></div>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="mainGrid">
    <div class="glass calendar-area">
      <div class="cal-controls">
        <div style="display:flex; align-items:center; gap:8px;">
          <button class="cal-btn" id="prevMonth">‚Äπ</button>
          <button class="cal-btn" id="nextMonth">‚Ä∫</button>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
          <div class="month-year" id="monthLabel">Monat</div>
          <select id="yearSelect" class="small"></select>
        </div>
      </div>

      <div class="dow-row" id="dowRow">
        <div class="dow">Mo</div><div class="dow">Di</div><div class="dow">Mi</div><div class="dow">Do</div><div class="dow">Fr</div><div class="dow">Sa</div><div class="dow">So</div>
      </div>

      <div class="calendar-grid" id="calendarGrid" aria-live="polite"></div>
    </div>

    <aside class="rightCol">
      <div class="glass events">
        <h3 style="margin:0 0 8px 0;">Ereignis-Liste</h3>
        <div id="eventList" class="small"></div>
      </div>

      <div class="glass notes">
        <h3 style="margin:0 0 8px 0;">Notizen</h3>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <input id="noteInput" type="text" placeholder="Notiz eingeben‚Ä¶" />
          <button id="addNoteBtn">Hinzuf√ºgen</button>
        </div>
        <div id="notesList" class="small"></div>
      </div>
    </aside>
  </div>

  <!-- Plants collapsible -->
  <div class="glass" id="plantsSection">
    <div class="plants-header">
      <h3 style="margin:0">Pflanzen</h3>
      <button class="toggle-btn" id="plantsToggle">‚ñº Pflanzen anzeigen</button>
    </div>

    <div id="plantArea" class="plants-grid hidden" aria-hidden="true"></div>
    <div id="plantAdd" class="hidden" style="margin-top:8px;">
      <input id="newPlantName" type="text" placeholder="Neue Pflanze Name" />
      <div style="margin-top:8px;"><button id="addPlantBtn" class="btn">Hinzuf√ºgen</button></div>
    </div>
  </div>
</div>

<script>
/* ===========================
   App state (kept from your working version, extended)
   =========================== */
const months = ["Jan","Feb","M√§r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];

let plants = [
  {name:"Hibiskus / Roseneibisch", harvest:false, cut:[6,7]},
  {name:"Zuckerrohr-Palmen", harvest:false, cut:[5,6]},
  {name:"Apfelbaum", harvest:true, harvestRange:[8,9], cut:[2,3]},
  {name:"Kirschbaum", harvest:true, harvestRange:[6,7], cut:[2,3]},
  {name:"Pflaumenbaum", harvest:true, harvestRange:[8,9], cut:[2,3]},
  {name:"Johannisbeere", harvest:true, harvestRange:[7,7], cut:[2,3]},
  {name:"Himbeere", harvest:true, harvestRange:[7,8], cut:[3,4]},
  {name:"Amerikanische Heidelbeere", harvest:true, harvestRange:[7,8], cut:[2,3]},
  {name:"Erdbeeren", harvest:true, harvestRange:[6,7], cut:[2,3]},
  {name:"Fetthenne", harvest:false, cut:[9,10]},
  {name:"K√ºrbis", harvest:true, unit:"St√ºck", harvestRange:[9,10]},
  {name:"Zucchini", harvest:true, unit:"St√ºck", harvestRange:[7,8]},
];

let events = []; // array of "YYYY-MM-DD | label"
let notes = [];  // array of {id,text,iso}
let wateringMap = {}; // { "YYYY-MM-DD": true }
let winterChecklist = []; // array of {id,text,done,timestamp?}

/* DOM refs */
const monthLabel = document.getElementById('monthLabel');
const yearSelect = document.getElementById('yearSelect');
const calendarGrid = document.getElementById('calendarGrid');
const eventList = document.getElementById('eventList');
const notesList = document.getElementById('notesList');
const noteInput = document.getElementById('noteInput');
const addNoteBtn = document.getElementById('addNoteBtn');
const todoList = document.getElementById('todoList');
const weatherIcon = document.getElementById('weatherIcon');
const weatherTemp = document.getElementById('weatherTemp');
const rainProbEl = document.getElementById('rainProb');
const waterBtn = document.getElementById('waterBtn');
const winterBtn = document.getElementById('winterBtn');
const winterChecklistInline = document.getElementById('winterChecklistInline');
const checklistItems = document.getElementById('checklistItems');
const newChecklistItem = document.getElementById('newChecklistItem');
const addChecklistBtn = document.getElementById('addChecklistBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');
const syncStatus = document.getElementById('syncStatus');
const plantArea = document.getElementById('plantArea');
const plantAdd = document.getElementById('plantAdd');
const plantsToggle = document.getElementById('plantsToggle');
const addPlantBtn = document.getElementById('addPlantBtn');
const newPlantName = document.getElementById('newPlantName');

let current = new Date();
let selectedDateISO = null; // YYYY-MM-DD

/* ===========================
   Firebase setup (replace config)
   ===========================
   Paste your firebaseConfig object below (from Firebase console)
*/
let useFirestore = false;
let db = null;
const firebaseConfig = {
  apiKey: "AIzaSyB2UunTDA4JBfJIU2kqLnE_O3xQY44lIG0",
  authDomain: "gartenplaner-ca2cf.firebaseapp.com",
  projectId: "gartenplaner-ca2cf",
  storageBucket: "gartenplaner-ca2cf.firebasestorage.app",
  messagingSenderId: "648271569301",
  appId: "1:648271569301:web:b3823f824cba58b180169c"
};

try {
  if (firebaseConfig && firebaseConfig.apiKey) {
    firebase.initializeApp(firebaseConfig);
    firebase.auth().signInAnonymously().catch(e=>console.warn('Firebase auth',e));
    db = firebase.firestore();
    useFirestore = true;
    syncStatus.textContent = 'Verbunden: Firebase (Realtime)';
    setupFirestoreListeners();
  } else {
    syncStatus.textContent = 'Lokaler Modus (kein Firebase konfiguriert)';
  }
} catch(err){
  console.warn('Firebase init failed', err);
  syncStatus.textContent = 'Firebase-Fehler (Lokaler Modus)';
}

/* ===========================
   Firestore listeners & writes
   =========================== */
function setupFirestoreListeners(){
  if(!db) return;

  // events
  db.collection('events').orderBy('createdAt','desc').onSnapshot(snap=>{
    events = [];
    snap.forEach(doc=>{
      const d = doc.data();
      if(d.date && d.text){
        events.push(`${d.date} | ${d.text}`);
      }
    });
    renderEvents();
    renderCalendar();
  });

  // notes
  db.collection('notes').orderBy('createdAt','desc').onSnapshot(snap=>{
    notes = [];
    snap.forEach(doc=>{
      const d = doc.data();
      notes.push({ id: doc.id, text: d.text, iso: d.createdAt? d.createdAt.toDate().toISOString() : new Date().toISOString() });
    });
    renderNotes();
  });

  // plants (if any in DB, load them; else keep local defaults)
  db.collection('plants').onSnapshot(snap=>{
    const ptmp = [];
    snap.forEach(doc=>{
      const d = doc.data();
      // store doc id so we can delete specific doc later
      d._id = doc.id;
      ptmp.push(d);
    });
    if(ptmp.length>0){
      plants = ptmp;
      renderPlants();
      renderTodo();
      renderCalendar();
    }
  });

  // watering markers: store doc ids? we keep map of dates true
  db.collection('watering').onSnapshot(snap=>{
    wateringMap = {};
    snap.forEach(doc=>{
      const d = doc.data();
      if(d.date) wateringMap[d.date] = true;
    });
    renderCalendar();
  });

  // winter checklist stored as single doc in appdata/winterChecklist
  db.collection('appdata').doc('winterChecklist').onSnapshot(doc=>{
    const d = doc.data();
    if(d && Array.isArray(d.items)){
      winterChecklist = d.items;
      renderChecklistItems();
    }
  });
}

// helper: write event to firestore (also works local)
async function saveEventToFirestore(dateISO, text){
  if(!useFirestore || !db){
    events.unshift(`${dateISO} | ${text}`);
    renderEvents(); renderCalendar();
    return;
  }
  try{
    await db.collection('events').add({ date: dateISO, text, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  }catch(e){ console.warn('saveEvent', e); }
}

/* Watering toggle: add/delete doc in watering collection */
async function toggleWateringFor(dateISO){
  if(!useFirestore || !db){
    if(wateringMap[dateISO]){ delete wateringMap[dateISO]; } else { wateringMap[dateISO] = true; }
    renderCalendar();
    return;
  }
  try{
    const q = await db.collection('watering').where('date','==',dateISO).get();
    if(!q.empty){
      const id = q.docs[0].id;
      await db.collection('watering').doc(id).delete();
    } else {
      await db.collection('watering').add({ date: dateISO, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    }
  }catch(e){ console.warn('toggleWateringFor', e); }
}

/* Save checklist to Firestore single doc */
async function saveChecklistToFirestore(){
  if(!useFirestore || !db){
    renderChecklistItems();
    return;
  }
  try{
    // Use serverTimestamp for items with done=true and no timestamp
    const itemsToSave = winterChecklist.map(it => {
      const copy = Object.assign({}, it);
      // if done and timestamp is the special string 'server' we set FieldValue.serverTimestamp
      if(copy.timestamp === 'serverTS') {
        // serverTS placeholder -> replace later in set with FieldValue.serverTimestamp via update
        // But Firestore can't accept serverTimestamp inside nested arrays easily here; we'll set whole doc
      }
      return copy;
    });
    // We will set the doc directly; if items contain firebase FieldValue.serverTimestamp it will be set properly.
    // Convert any item.timestamp === 'serverTS' to FieldValue.serverTimestamp()
    const itemsForWrite = winterChecklist.map(it=>{
      const c = {...it};
      if(c.timestamp === 'serverTS') c.timestamp = firebase.firestore.FieldValue.serverTimestamp();
      return c;
    });
    await db.collection('appdata').doc('winterChecklist').set({ items: itemsForWrite }, { merge:true });
  }catch(e){ console.warn('saveChecklist', e); }
}

/* Save plants to Firestore when added or deleted (best-effort) */
async function addPlantToFirestore(plantObj){
  if(!useFirestore || !db) return;
  try{
    await db.collection('plants').add(plantObj);
  }catch(e){ console.warn('addPlantToFirestore', e); }
}
async function deletePlantFromFirestoreByName(name){
  if(!useFirestore || !db) return;
  try{
    const q = await db.collection('plants').where('name','==',name).get();
    if(!q.empty){
      // delete all matching docs (best-effort)
      const batch = db.batch ? db.batch() : null;
      q.forEach(doc=>{
        db.collection('plants').doc(doc.id).delete().catch(()=>{});
      });
    }
  }catch(e){ console.warn('deletePlantFromFirestoreByName', e); }
}

/* Import: write imported data into Firestore (non-destructive: adds items) */
async function importToFirestore(payload){
  if(!useFirestore || !db) return;
  try{
    // plants: add each as doc
    if(Array.isArray(payload.plants)){
      for(const p of payload.plants){
        await db.collection('plants').add(p);
      }
    }
    // events
    if(Array.isArray(payload.events)){
      for(const ev of payload.events){
        // ev format "YYYY-MM-DD | text" -> split
        const parts = String(ev).split(' | ');
        const date = parts[0] || null;
        const text = parts[1] || parts[0] || '';
        if(date && text) await db.collection('events').add({ date, text, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      }
    }
    // notes
    if(Array.isArray(payload.notes)){
      for(const n of payload.notes){
        const text = n.text || n;
        await db.collection('notes').add({ text, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      }
    }
    // watering -> if provided as map, add dates
    if(payload.watering && typeof payload.watering === 'object'){
      for(const k in payload.watering){
        if(payload.watering[k]) await db.collection('watering').add({ date: k, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      }
    }
    alert('Import in Firestore abgeschlossen (hinzugef√ºgt).');
  }catch(e){ console.warn('importToFirestore', e); alert('Import in Firestore fehlgeschlagen: ' + e.message); }
}

/* ===========================
   Utility & rendering
   =========================== */
function uid(){ return Math.random().toString(36).slice(2,9); }
function pad(n){ return String(n).padStart(2,'0'); }
function isoFor(y,m,d){ return `${y}-${pad(m)}-${pad(d)}`; }

/* Year select */
function populateYears(){
  const y = new Date().getFullYear();
  yearSelect.innerHTML = '';
  for(let i=y-5;i<=y+5;i++){
    const opt = document.createElement('option');
    opt.value = i; opt.textContent = i;
    if(i===current.getFullYear()) opt.selected = true;
    yearSelect.appendChild(opt);
  }
}
populateYears();

/* Calendar rendering + selection + watering icons */
function renderCalendar(){
  calendarGrid.innerHTML = '';
  const y = current.getFullYear();
  const m = current.getMonth();
  monthLabel.textContent = current.toLocaleString('de-DE',{month:'long', year:'numeric'});

  const firstDate = new Date(y,m,1);
  const offset = (firstDate.getDay() + 6) % 7;
  for(let i=0;i<offset;i++){
    const blank = document.createElement('div');
    blank.className = 'day';
    blank.style.background='transparent';
    calendarGrid.appendChild(blank);
  }

  const daysInMonth = new Date(y,m+1,0).getDate();
  for(let d=1; d<=daysInMonth; d++){
    const cell = document.createElement('div');
    cell.className = 'day';
    const num = document.createElement('div'); num.className='num'; num.textContent = d+'.';
    cell.appendChild(num);
    const iso = isoFor(y,m+1,d);

    // show event chips (existing format "YYYY-MM-DD | text")
    events.forEach(ev=>{
      if(typeof ev === 'string' && ev.startsWith(iso + ' | ')){
        const txt = ev.split(' | ')[1] || ev;
        const chip = document.createElement('div');
        chip.className = 'event-chip ' + (txt.toLowerCase().includes('ernte') ? 'chip-harvest' : 'chip-prune');
        chip.textContent = txt;
        cell.appendChild(chip);
      }
    });

    // watering icon
    if(wateringMap[iso]){
      const w = document.createElement('span');
      w.className = 'watering-icon';
      w.title = 'Gegossen';
      w.textContent = 'üíß';
      cell.appendChild(w);
    }

    // selection behavior
    cell.addEventListener('click', ()=>{
      // clear prev selection
      document.querySelectorAll('.day.selected').forEach(el=>el.classList.remove('selected'));
      cell.classList.add('selected');
      selectedDateISO = iso;
    });

    calendarGrid.appendChild(cell);
  }
  renderTodo(); // update ToDo on calendar render
}

/* Events & notes rendering */
function renderEvents(){
  eventList.innerHTML = '';
  events.forEach(e=>{
    const div = document.createElement('div'); div.className='item';
    const [date,txt] = e.split(' | ');
    div.innerHTML = `<div style="font-weight:600">${txt}</div><div class="small" style="color:var(--muted)">${date}</div>`;
    eventList.appendChild(div);
  });
}

function renderNotes(){
  notesList.innerHTML = '';
  notes.slice().reverse().forEach(n=>{
    const div = document.createElement('div'); div.className='item';
    const txt = document.createElement('div'); txt.textContent = n.text;
    const meta = document.createElement('div'); meta.className='small'; meta.style.color='var(--muted)';
    meta.textContent = new Date(n.iso).toLocaleString('de-DE');
    const del = document.createElement('button'); del.textContent='√ó'; del.style.marginLeft='8px';
    del.onclick = async ()=> {
      if(useFirestore && db){
        // best-effort: find notes matching text and delete one
        try{
          const q = await db.collection('notes').where('text','==',n.text).get();
          if(!q.empty){
            const id = q.docs[0].id;
            await db.collection('notes').doc(id).delete();
          }
        }catch(e){ console.warn('delete note', e); }
      }
      notes = notes.filter(x=>x.id!==n.id);
      renderNotes(); renderCalendar();
    };
    div.appendChild(txt); div.appendChild(meta); div.appendChild(del);
    notesList.appendChild(div);
  });
}

/* ToDo generation */
function renderTodo(){
  todoList.innerHTML = '';
  const month = current.getMonth() + 1;
  plants.forEach(p=>{
    if(Array.isArray(p.harvestRange) && p.harvestRange.length>=2){
      const [from,to] = p.harvestRange;
      const inRange = from <= to ? (month>=from && month<=to) : (month>=from || month<=to);
      if(inRange){
        const el = document.createElement('div'); el.className='todo-item'; el.textContent = p.name + ' - Ernte f√§llig';
        todoList.appendChild(el);
      }
    }
    if(Array.isArray(p.cut) && p.cut.length>=2){
      const [from,to] = p.cut;
      const inRange = from <= to ? (month>=from && month<=to) : (month>=from || month<=to);
      if(inRange){
        const el = document.createElement('div'); el.className='todo-item'; el.textContent = p.name + ' - Zuschnitt f√§llig';
        todoList.appendChild(el);
      }
    }
  });
}

/* Plants rendering (collapsible) */
function renderPlants(){
  plantArea.innerHTML = '';
  plants.forEach((p, idx)=>{
    const box = document.createElement('div'); box.className='plant-box';
    const title = document.createElement('div'); title.style.fontWeight='700'; title.textContent = p.name; box.appendChild(title);

    // cut
    const cutSec = document.createElement('div'); cutSec.className='plant-section';
    const cutLabel = document.createElement('label');
    const cutCb = document.createElement('input'); cutCb.type='checkbox';
    let cutState = 0;
    cutCb.addEventListener('click', ()=>{
      cutState++;
      const iso = isoFor(new Date().getFullYear(), new Date().getMonth()+1, new Date().getDate());
      if(cutState===1){ saveEventToFirestore(iso, `${p.name}: Zuschnitt in Arbeit`); }
      else if(cutState===2){ saveEventToFirestore(iso, `${p.name}: Zuschnitt erledigt`); cutCb.disabled=true; }
    });
    cutLabel.appendChild(cutCb); cutLabel.append(' erledigt'); cutSec.appendChild(cutLabel);

    // cut period selects
    const fromSel = document.createElement('select'); const toSel = document.createElement('select');
    const emptyOpt = document.createElement('option'); emptyOpt.value=''; emptyOpt.text='-'; fromSel.appendChild(emptyOpt.cloneNode(true)); toSel.appendChild(emptyOpt.cloneNode(true));
    for(let i=1;i<=12;i++){ const o=document.createElement('option'); o.value=i; o.textContent = months[i-1]; if(p.cut && p.cut[0]===i) o.selected=true; fromSel.appendChild(o); const o2=o.cloneNode(true); if(p.cut && p.cut[1]===i) o2.selected=true; toSel.appendChild(o2); }
    const periodWrap = document.createElement('div'); periodWrap.style.marginTop='6px'; periodWrap.append('Zeitraum: '); periodWrap.appendChild(fromSel); periodWrap.append(' bis '); periodWrap.appendChild(toSel);
    fromSel.addEventListener('change', ()=>{ p.cut = [ Number(fromSel.value)||null, Number(toSel.value)||null ]; renderCalendar(); renderTodo(); });
    toSel.addEventListener('change', ()=>{ p.cut = [ Number(fromSel.value)||null, Number(toSel.value)||null ]; renderCalendar(); renderTodo(); });

    cutSec.appendChild(periodWrap);
    box.appendChild(cutSec);

    // harvest
    const harvSec = document.createElement('div'); harvSec.className='plant-section';
    const harvEnableLbl = document.createElement('label');
    const harvEnable = document.createElement('input'); harvEnable.type='checkbox';
    harvEnable.checked = !!p.harvest;
    harvEnable.addEventListener('change', ()=>{ p.harvest = harvEnable.checked; renderPlants(); renderTodo(); });
    harvEnableLbl.appendChild(harvEnable); harvEnableLbl.append(' Ernte aktivieren');
    harvSec.appendChild(harvEnableLbl);

    if(p.harvest){
      const harvDoneLabel = document.createElement('label');
      const harvCb = document.createElement('input'); harvCb.type='checkbox';
      let harvState = 0;
      const amount = document.createElement('input'); amount.type='number'; amount.placeholder = p.unit || 'kg';
      harvCb.addEventListener('click', ()=>{
        harvState++;
        const iso = isoFor(new Date().getFullYear(), new Date().getMonth()+1, new Date().getDate());
        if(harvState===1){ saveEventToFirestore(iso, `${p.name}: Ernte in Arbeit`); }
        else if(harvState===2){ saveEventToFirestore(iso, `${p.name}: Ernte erledigt ${amount.value||''} ${p.unit||'kg'}`); harvCb.disabled=true; }
      });
      harvDoneLabel.appendChild(harvCb); harvDoneLabel.append(' erledigt'); harvSec.appendChild(harvDoneLabel);

      // harvest range selects
      const hf = document.createElement('select'); const ht = document.createElement('select');
      hf.appendChild(emptyOpt.cloneNode(true)); ht.appendChild(emptyOpt.cloneNode(true));
      for(let i=1;i<=12;i++){ const o=document.createElement('option'); o.value=i; o.textContent = months[i-1]; if(p.harvestRange && p.harvestRange[0]===i) o.selected=true; hf.appendChild(o); const o2=o.cloneNode(true); if(p.harvestRange && p.harvestRange[1]===i) o2.selected=true; ht.appendChild(o2); }
      hf.addEventListener('change', ()=>{ p.harvestRange = [ Number(hf.value)||null, Number(ht.value)||null ]; renderTodo(); });
      ht.addEventListener('change', ()=>{ p.harvestRange = [ Number(hf.value)||null, Number(ht.value)||null ]; renderTodo(); });

      const harvRangeWrap = document.createElement('div');
      harvRangeWrap.append('Zeitraum: '); harvRangeWrap.appendChild(hf); harvRangeWrap.append(' bis '); harvRangeWrap.appendChild(ht);
      harvSec.appendChild(harvRangeWrap);
      harvSec.appendChild(document.createElement('br'));
      harvSec.appendChild(amount);
    }

    const del = document.createElement('button'); del.textContent = 'Pflanze l√∂schen'; del.style.marginTop = '8px';
    del.addEventListener('click', async ()=>{ 
      const removed = plants.splice(idx,1);
      renderPlants(); renderCalendar(); renderTodo(); 
      // delete from firestore by name (best-effort)
      if(useFirestore && db && removed && removed[0] && removed[0].name){
        await deletePlantFromFirestoreByName(removed[0].name);
      }
    });

    box.appendChild(harvSec);
    box.appendChild(del);
    plantArea.appendChild(box);
  });
}

/* toggle plants UI */
plantsToggle.addEventListener('click', ()=>{
  const visible = !plantArea.classList.contains('hidden');
  if(visible){
    plantArea.classList.add('hidden'); plantAdd.classList.add('hidden'); plantsToggle.textContent = '‚ñº Pflanzen anzeigen';
  } else {
    plantArea.classList.remove('hidden'); plantAdd.classList.remove('hidden'); plantsToggle.textContent = '‚ñ≤ Pflanzen verbergen';
    renderPlants();
  }
});

/* add plant */
addPlantBtn.addEventListener('click', async ()=>{
  const name = newPlantName.value.trim();
  if(!name) return;
  const obj = { name, harvest:true, harvestRange:null, cut:null };
  plants.push(obj);
  newPlantName.value = '';
  renderPlants();
  renderTodo();
  // add to firestore
  if(useFirestore && db) await addPlantToFirestore(obj);
});

/* export / import (keeps existing behavior + writes to Firestore on import) */
exportBtn.addEventListener('click', ()=>{
  const payload = { plants, events, notes, watering: wateringMap };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `garten-dashboard-${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href);
});
importBtn.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = async ()=> {
    try{
      const data = JSON.parse(r.result);
      if(Array.isArray(data.plants)) { 
        // append to local and to firestore
        for(const p of data.plants){
          plants.push(p);
          if(useFirestore && db) await db.collection('plants').add(p);
        }
      }
      if(Array.isArray(data.events)){
        for(const ev of data.events){
          // add to local and firestore
          events.push(ev);
          if(useFirestore && db){
            const parts = String(ev).split(' | ');
            await db.collection('events').add({ date: parts[0], text: parts[1] || parts[0], createdAt: firebase.firestore.FieldValue.serverTimestamp() });
          }
        }
      }
      if(Array.isArray(data.notes)){
        for(const n of data.notes){
          const text = typeof n === 'object' ? (n.text || '') : n;
          notes.push({ id: uid(), text, iso: new Date().toISOString() });
          if(useFirestore && db) await db.collection('notes').add({ text, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        }
      }
      // watering
      if(data.watering && typeof data.watering === 'object'){
        for(const k in data.watering){
          if(data.watering[k]){
            wateringMap[k] = true;
            if(useFirestore && db) await db.collection('watering').add({ date: k, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
          }
        }
      }
      renderPlants(); renderCalendar(); renderEvents(); renderNotes(); renderTodo();
      alert('Import erfolgreich (lokal + Firestore falls aktiviert).');
    }catch(err){ alert('Import fehlgeschlagen: ' + err.message); }
  };
  r.readAsText(f);
});

/* Weather (robust loader, auto-refresh) */
async function loadWeather(){
  try {
    const url = 'https://api.open-meteo.com/v1/forecast?latitude=48.408&longitude=10.0375&daily=precipitation_probability_mean,precipitation_sum,temperature_2m_min,sunshine_duration,windspeed_10m_max&current_weather=true&timezone=Europe%2FBerlin';
    const res = await fetch(url);
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();

    const cw = data.current_weather || {};
    if (cw.temperature !== undefined) weatherTemp.textContent = Math.round(cw.temperature) + '¬∞C'; else weatherTemp.textContent = '‚Äî¬∞C';
    const code = Number(cw.weathercode ?? -1);
    if(code >= 0){
      if(code < 3) weatherIcon.src = 'https://img.icons8.com/ios-filled/50/000000/sun.png';
      else if(code < 61) weatherIcon.src = 'https://img.icons8.com/ios-filled/50/000000/partly-cloudy-day.png';
      else weatherIcon.src = 'https://img.icons8.com/ios-filled/50/000000/rain.png';
    } else weatherIcon.src = '';

    // rain probability
    const probArr = data.daily?.precipitation_probability_mean;
    const prob = Array.isArray(probArr) && probArr.length > 0 ? Math.round(probArr[0]) : null;
    rainProbEl.textContent = prob !== null ? 'Regenwahrscheinlichkeit: ' + prob + '%' : 'Regenwahrscheinlichkeit: ‚Äî%';

    // water hint (today + tomorrow precipitation sum)
    const precArr = data.daily?.precipitation_sum || [];
    const rainToday = Number(precArr[0] ?? 0);
    const rainTomorrow = Number(precArr[1] ?? 0);
    document.getElementById('waterHint').textContent = 'Gie√ühinweis: ' + ((rainToday + rainTomorrow) < 1 ? 'Gie√üen empfohlen' : 'Kein Gie√üen n√∂tig');

    // frost
    const tminArr = data.daily?.temperature_2m_min;
    const tmin = Array.isArray(tminArr) && tminArr.length>0 ? Number(tminArr[0]) : null;
    document.getElementById('frostWarn').textContent = 'Frostwarnung: ' + ((tmin !== null && tmin < 2) ? 'Achtung: Bodenfrost m√∂glich!' : 'Kein Frost erwartet');

    // sun hours
    const sunArr = data.daily?.sunshine_duration;
    let sunHours = '‚Äî';
    if(Array.isArray(sunArr) && sunArr.length > 0){
      let v = Number(sunArr[0]);
      if(isFinite(v)){
        if(v > 24) v = v / 3600;
        sunHours = (Math.round(v*10)/10) + 'h';
      }
    }
    document.getElementById('sunHours').textContent = 'Sonnenstunden: ' + sunHours;

    // wind
    const windArr = data.daily?.windspeed_10m_max;
    const windVal = (Array.isArray(windArr) && windArr.length>0) ? Number(windArr[0]) : (cw.windspeed ?? null);
    const windText = (windVal === null) ? '‚Äî' : (windVal > 50 ? 'Sturmwarnung! (' + windVal + ' km/h)' : windVal + ' km/h');
    document.getElementById('windWarn').textContent = 'Wind: ' + windText;

    // pollen (separate call)
    try{
      const pRes = await fetch('https://api.open-meteo.com/v1/forecast?latitude=48.408&longitude=10.0375&daily=alder_pollen,birch_pollen,grass_pollen,ragweed_pollen&timezone=Europe%2FBerlin');
      if(pRes.ok){
        const pData = await pRes.json();
        const grass = pData.daily?.grass_pollen;
        let pollenText = '‚Äî';
        if(Array.isArray(grass) && grass.length>0){
          const val = Number(grass[0]);
          const labels = ['keine Belastung','gering','mittel','hoch'];
          pollenText = labels[val] ?? String(val);
        }
        document.getElementById('pollenInfo').textContent = 'Pollenflug (Gr√§ser): ' + pollenText;
      } else document.getElementById('pollenInfo').textContent = 'Pollenflug: ‚Äî';
    }catch(pErr){
      document.getElementById('pollenInfo').textContent = 'Pollenflug: ‚Äî';
      console.warn('Pollen-API Fehler', pErr);
    }

    // ensure weather box opens wetter.com (single handler)
    const wb = document.getElementById('weatherBox');
    if(wb) wb.onclick = () => window.open('https://www.wetter.com/wetter/pfuhl/DE0004144.html','_blank');

  } catch(err){
    console.warn('Fehler beim Laden der Wetterdaten:', err);
    weatherTemp.textContent = '‚Äî¬∞C';
    rainProbEl.textContent = 'Regenwahrscheinlichkeit: ‚Äî%';
    document.getElementById('waterHint').textContent = 'Gie√ühinweis: ‚Äî';
    document.getElementById('frostWarn').textContent = 'Frostwarnung: ‚Äî';
    document.getElementById('sunHours').textContent = 'Sonnenstunden: ‚Äî';
    document.getElementById('windWarn').textContent = 'Wind: ‚Äî';
    document.getElementById('pollenInfo').textContent = 'Pollenflug: ‚Äî';
  }
}
loadWeather();
setInterval(loadWeather, 20 * 60 * 1000);

/* ===== initial render & controls ===== */
function renderAll(){
  renderCalendar();
  renderEvents();
  renderNotes();
  renderPlants();
  renderChecklistItems();
}
renderAll();

document.getElementById('prevMonth').addEventListener('click', ()=>{ current.setMonth(current.getMonth()-1); renderCalendar(); });
document.getElementById('nextMonth').addEventListener('click', ()=>{ current.setMonth(current.getMonth()+1); renderCalendar(); });
yearSelect.addEventListener('change', ()=>{ current.setFullYear(Number(yearSelect.value)); renderCalendar(); });

/* Add note */
addNoteBtn.addEventListener('click', ()=>{
  const v = noteInput.value.trim(); if(!v) return;
  noteInput.value = '';
  saveNoteToFirestore(v);
});

/* save note (to Firestore or local) */
async function saveNoteToFirestore(text){
  if(!useFirestore || !db){
    notes.push({ id: uid(), text, iso: new Date().toISOString() });
    renderNotes(); return;
  }
  try{
    await db.collection('notes').add({ text, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  }catch(e){ console.warn('saveNote', e); }
}

/* add event for today helper */
function addEventForToday(label){
  const now = new Date();
  const iso = isoFor(now.getFullYear(), now.getMonth()+1, now.getDate());
  saveEventToFirestore(iso, label);
}

/* Water button behavior */
waterBtn.addEventListener('click', async ()=>{
  if(!selectedDateISO){
    alert('Bitte zun√§chst ein Datum im Kalender ausw√§hlen, auf das du das Gie√üen setzen m√∂chtest.');
    return;
  }
  await toggleWateringFor(selectedDateISO);
});

/* ===== Winter-Checklist inline behavior ===== */
winterBtn.addEventListener('click', ()=>{
  const open = !winterChecklistInline.classList.contains('hidden');
  if(open){
    winterChecklistInline.classList.add('hidden');
    winterChecklistInline.setAttribute('aria-hidden','true');
  } else {
    winterChecklistInline.classList.remove('hidden');
    winterChecklistInline.setAttribute('aria-hidden','false');
    // ensure we have latest from firestore
    if(useFirestore && db) loadChecklistFromFirestore();
    renderChecklistItems();
  }
});

/* render checklist items */
function renderChecklistItems(){
  checklistItems.innerHTML = '';
  (winterChecklist || []).forEach((it, idx)=>{
    const row = document.createElement('div'); row.className='row';
    const top = document.createElement('div'); top.className='row-top';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!it.done;
    const txt = document.createElement('input'); txt.type='text'; txt.value = it.text || ''; txt.placeholder = 'Aufgabe...';
    txt.addEventListener('change', async ()=>{ winterChecklist[idx].text = txt.value; await saveChecklistToFirestore(); renderChecklistItems(); });
    const del = document.createElement('button'); del.className='icon-btn'; del.textContent='√ó'; del.title='L√∂schen';
    del.addEventListener('click', async ()=>{
      winterChecklist.splice(idx,1);
      await saveChecklistToFirestore();
      renderChecklistItems();
    });
    top.appendChild(cb); top.appendChild(txt); top.appendChild(del);
    row.appendChild(top);

    // timestamp area (small, shown only when done)
    const ts = document.createElement('div'); ts.className='small-timestamp';
    if(it.done && it.timestamp){
      // timestamp may be Firestore Timestamp or ISO string
      let tstr = '';
      if(typeof it.timestamp === 'object' && it.timestamp.toDate){
        tstr = new Date(it.timestamp.toDate()).toLocaleString('de-DE');
      } else if(typeof it.timestamp === 'string'){
        tstr = new Date(it.timestamp).toLocaleString('de-DE');
      } else {
        tstr = new Date().toLocaleString('de-DE');
      }
      ts.textContent = 'Erledigt: ' + tstr;
      ts.style.display = 'block';
    } else {
      ts.style.display = 'none';
    }
    row.appendChild(ts);

    cb.addEventListener('change', async ()=>{
      const checked = cb.checked;
      winterChecklist[idx].done = checked;
      if(checked){
        // mark timestamp as serverTS placeholder; saveChecklistToFirestore converts to FieldValue.serverTimestamp
        winterChecklist[idx].timestamp = 'serverTS';
      } else {
        winterChecklist[idx].timestamp = null;
      }
      await saveChecklistToFirestore();
      // refresh local copy: load from firestore if used
      if(useFirestore && db) await loadChecklistFromFirestore();
      renderChecklistItems();
    });

    checklistItems.appendChild(row);
  });
}

/* add checklist item */
addChecklistBtn.addEventListener('click', async ()=>{
  const v = newChecklistItem.value.trim(); if(!v) return;
  const item = { id: uid(), text: v, done:false, timestamp: null };
  winterChecklist.push(item);
  newChecklistItem.value = '';
  await saveChecklistToFirestore();
  renderChecklistItems();
});

/* load checklist from firestore (populate winterChecklist) */
async function loadChecklistFromFirestore(){
  if(!useFirestore || !db) return;
  try{
    const doc = await db.collection('appdata').doc('winterChecklist').get();
    if(doc.exists){
      const d = doc.data();
      if(d && Array.isArray(d.items)){
        winterChecklist = d.items.map(it=>{
          // normalize timestamps if Firestore stored server timestamp
          if(it.timestamp && it.timestamp.seconds && typeof it.timestamp.seconds === 'number') return {...it};
          return {...it};
        });
      }
    }
    renderChecklistItems();
  }catch(e){ console.warn('loadChecklist', e); }
}
loadChecklistFromFirestore();

/* saveChecklistToFirestore implemented earlier */

/* ===== initial checklist render if any ===== */
renderChecklistItems();

/* end of script */
</script>
</body>
</html>
